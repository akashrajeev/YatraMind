<div class="explanation">
  <h3>Trainset {{ trainset_id }} — Role: {{ role }}</h3>
  <p>Composite score: <strong>{{ score | round(3) }}</strong></p>
  
  <h4>Top Contributing Reasons</h4>
  <ul>
  {% for r in top_reasons %}
    <li class="positive-reason">{{ r }}</li>
  {% endfor %}
  {% if not top_reasons %}
    <li class="no-reasons">No specific positive factors identified</li>
  {% endif %}
  </ul>
  
  <h4>Top Risks</h4>
  <ul>
  {% for r in top_risks %}
    <li class="risk-item">{{ r }}</li>
  {% endfor %}
  {% if not top_risks %}
    <li class="no-risks">No significant risks identified</li>
  {% endif %}
  </ul>
  
  {% if violations %}
  <h4>Rule Violations</h4>
  <ul class="violations">
  {% for v in violations %}
    <li class="violation-item">{{ v }}</li>
  {% endfor %}
  </ul>
  {% endif %}
  
  {% if shap_values %}
  <h4>Feature Impact Analysis</h4>
  <div class="shap-features-container">
    {% for f in shap_values %}
    <div class="shap-feature-item">
      <div class="feature-header">
        <span class="feature-name">{{ f.name }}</span>
        <span class="feature-impact impact-{{ f.impact }}">
          {% if f.impact == 'positive' %}↑{% elif f.impact == 'negative' %}↓{% else %}→{% endif %}
        </span>
      </div>
      <div class="feature-bar-container">
        <div class="feature-bar impact-{{ f.impact }}" style="width: {{ (f.value * 100) | round(1) }}%"></div>
        <span class="feature-value">{{ (f.value * 100) | round(1) }}%</span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  
  <div class="explanation-footer">
    <small>Generated on {{ timestamp | default('now') | strftime('%Y-%m-%d %H:%M:%S') }}</small>
  </div>
</div>

<style>
.explanation {
  font-family: Arial, sans-serif;
  max-width: 600px;
  margin: 20px;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background-color: #f9f9f9;
}

.explanation h3 {
  color: #333;
  margin-top: 0;
  border-bottom: 2px solid #007bff;
  padding-bottom: 10px;
}

.explanation h4 {
  color: #555;
  margin-top: 20px;
  margin-bottom: 10px;
}

.explanation ul {
  margin: 0;
  padding-left: 20px;
}

.explanation li {
  margin-bottom: 5px;
}

.positive-reason {
  color: #28a745;
}

.risk-item {
  color: #dc3545;
}

.violation-item {
  color: #dc3545;
  font-weight: bold;
}

.shap-features-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 10px;
}

.shap-feature-item {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.feature-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.feature-name {
  font-weight: bold;
  color: #333;
  font-size: 0.95em;
}

.feature-impact {
  font-weight: bold;
  font-size: 1.2em;
}

.feature-bar-container {
  position: relative;
  width: 100%;
  height: 24px;
  background-color: #e9ecef;
  border-radius: 4px;
  overflow: hidden;
}

.feature-bar {
  height: 100%;
  transition: width 0.3s ease;
  border-radius: 4px;
}

.feature-bar.impact-positive {
  background-color: #28a745;
}

.feature-bar.impact-negative {
  background-color: #dc3545;
}

.feature-bar.impact-neutral {
  background-color: #6c757d;
}

.feature-value {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-family: monospace;
  font-size: 0.85em;
  font-weight: bold;
  color: #333;
  text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
}

.impact-positive {
  color: #28a745;
}

.impact-negative {
  color: #dc3545;
}

.impact-neutral {
  color: #6c757d;
}

.no-reasons, .no-risks {
  color: #6c757d;
  font-style: italic;
}

.explanation-footer {
  margin-top: 20px;
  padding-top: 10px;
  border-top: 1px solid #ddd;
  text-align: right;
}

@media print {
  .explanation {
    border: none;
    background-color: white;
    box-shadow: none;
  }
}
</style>


